{{ define "main" }}
{{ $renders := sort (default (slice) .Params.renders) "date" "desc" }}
<section class="gallery-hero">
  <div class="gallery-hero-content">
    <p class="gallery-kicker">3D Modeling</p>
    <h1>{{ .Title }}</h1>
    {{ with .Params.description }}
    <p class="gallery-intro">{{ . }}</p>
    {{ end }}
  </div>
</section>

{{ if gt (len $renders) 0 }}
<section class="gallery">
  <div class="gallery-grid">
    {{ range $renders }}
    {{ $render := . }}
    {{ $images := slice }}
    {{ if isset $render "images" }}
      {{ range $render.images }}
        {{ with $.Resources.GetMatch . }}
          {{ $images = $images | append . }}
        {{ end }}
      {{ end }}
    {{ else if isset $render "image" }}
      {{ with $.Resources.GetMatch $render.image }}
        {{ $images = $images | append . }}
      {{ end }}
    {{ end }}
    {{ $videoThumbs := slice }}
    {{ if isset $render "videos" }}
      {{ range $render.videos }}
        {{ $videoCover := $.Resources.GetMatch .cover }}
        {{ $videoMovie := $.Resources.GetMatch .movie }}
        {{ if and $videoCover $videoMovie }}
          {{ $videoDisplay := $videoCover.Fit "1200x900 jpg" }}
          {{ $videoThumb := $videoCover.Fit "400x400 jpg" }}
          {{ $videoThumbs = $videoThumbs | append (dict "cover" $videoCover "display" $videoDisplay "thumb" $videoThumb "movie" $videoMovie) }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{ $hasImages := gt (len $images) 0 }}
    {{ $hasVideos := gt (len $videoThumbs) 0 }}
    {{ $coverResource := "" }}
    {{ $coverLinkTarget := "" }}
    {{ if $hasImages }}
      {{ $coverResource = index $images 0 }}
      {{ $coverLinkTarget = $coverResource.RelPermalink }}
    {{ end }}
    {{ $initialVideo := "" }}
    {{ if and (not $hasImages) $hasVideos }}
      {{ $initialVideo = index $videoThumbs 0 }}
    {{ end }}
    {{ $defaultVideoPoster := "" }}
    {{ if $hasVideos }}
      {{ $defaultPosterResource := index (index $videoThumbs 0) "display" }}
      {{ $defaultVideoPoster = $defaultPosterResource.RelPermalink }}
    {{ end }}
    <article class="render-card">
      <div class="render-display">
        {{ with $coverResource }}
        {{ $coverDisplay := .Fit "1200x900 jpg" }}
        <a class="render-image-link{{ if $initialVideo }} is-hidden{{ end }}" href="{{ $coverLinkTarget }}" target="_blank" rel="noopener noreferrer">
          <img src="{{ $coverDisplay.RelPermalink }}" alt="{{ $render.title }} render">
        </a>
        {{ end }}
        {{ if $hasVideos }}
        {{ $videoClasses := "render-video" }}
        {{ if not $initialVideo }}
          {{ $videoClasses = printf "%s is-hidden" $videoClasses }}
        {{ end }}
        {{ $initialVideoMovie := "" }}
        {{ $initialVideoPoster := $defaultVideoPoster }}
        {{ if $initialVideo }}
          {{ $initialVideoMovie = (index $initialVideo "movie").RelPermalink }}
          {{ $initialPosterResource := index $initialVideo "display" }}
          {{ $initialVideoPoster = $initialPosterResource.RelPermalink }}
        {{ end }}
        <video class="{{ $videoClasses }}" controls playsinline loop preload="metadata" poster="{{ $initialVideoPoster }}" data-default-poster="{{ $defaultVideoPoster }}"{{ if $initialVideoMovie }} src="{{ $initialVideoMovie }}"{{ end }}></video>
        {{ end }}
      </div>
      <div class="render-card-body">
        <div class="render-meta">
          {{ with $render.date }}
          <time datetime="{{ . }}">{{ (time .).Format "02 Jan 2006" }}</time>
          {{ end }}
        </div>
        <h3>{{ $render.title }}</h3>
        {{ with $render.description }}
        <p>{{ . }}</p>
        {{ end }}
        {{ if or $hasImages $hasVideos }}
        <div class="render-thumbs" aria-label="Render viewpoints">
          {{ range $index, $img := $images }}
          {{ $displayAlt := $img.Fit "1200x900 jpg" }}
          {{ $thumb := $img.Fit "400x400 jpg" }}
          <button type="button" class="render-thumb{{ if eq $index 0 }} is-active{{ end }}" data-type="image" data-display="{{ $displayAlt.RelPermalink }}" data-original="{{ $img.RelPermalink }}" aria-pressed="{{ if eq $index 0 }}true{{ else }}false{{ end }}">
            <img src="{{ $thumb.RelPermalink }}" alt="{{ printf "%s angle %d" $render.title (add $index 1) }}">
          </button>
          {{ end }}
          {{ range $videoIndex, $video := $videoThumbs }}
          {{ $videoDisplay := index $video "display" }}
          {{ $videoThumb := index $video "thumb" }}
          {{ $videoMovie := index $video "movie" }}
          {{ $videoIsActive := and (eq $videoIndex 0) (eq (len $images) 0) }}
          <button type="button" class="render-thumb render-thumb-video{{ if $videoIsActive }} is-active{{ end }}" data-type="video" data-display="{{ $videoDisplay.RelPermalink }}" data-poster="{{ $videoDisplay.RelPermalink }}" data-original="{{ $videoMovie.RelPermalink }}" aria-pressed="{{ if $videoIsActive }}true{{ else }}false{{ end }}">
            <img src="{{ $videoThumb.RelPermalink }}" alt="{{ printf "%s animation %d" $render.title (add $videoIndex 1) }}">
            <span class="render-thumb-icon" aria-hidden="true">
              <svg viewBox="0 0 32 32" role="presentation" focusable="false">
                <circle cx="16" cy="16" r="14" />
                <polygon points="13,10 22,16 13,22" />
              </svg>
            </span>
          </button>
          {{ end }}
        </div>
        {{ end }}
      </div>
    </article>
    {{ end }}
  </div>
</section>
{{ else }}
<section class="gallery">
  <p>No renders published yet. Check back soon.</p>
</section>
{{ end }}

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.render-card').forEach(card => {
    const coverLink = card.querySelector('.render-image-link');
    const coverImg = coverLink?.querySelector('img');
    const videoPlayer = card.querySelector('.render-video');
    const thumbs = card.querySelectorAll('.render-thumb');

    const showImage = btn => {
      if (!coverLink || !coverImg) {
        return;
      }
      const display = btn.dataset.display;
      const original = btn.dataset.original;
      if (!display || !original) {
        return;
      }
      if (videoPlayer) {
        videoPlayer.pause();
        videoPlayer.removeAttribute('src');
        const defaultPoster = videoPlayer.dataset.defaultPoster;
        if (defaultPoster) {
          videoPlayer.poster = defaultPoster;
        }
        videoPlayer.load();
        videoPlayer.classList.add('is-hidden');
      }
      coverImg.src = display;
      coverLink.href = original;
      coverLink.classList.remove('is-hidden');
    };

    const showVideo = btn => {
      if (!videoPlayer) {
        return;
      }
      const videoSrc = btn.dataset.original;
      if (!videoSrc) {
        return;
      }
      if (coverLink) {
        coverLink.classList.add('is-hidden');
      }
      const poster = btn.dataset.poster || videoPlayer.dataset.defaultPoster || btn.dataset.display;
      if (poster) {
        videoPlayer.poster = poster;
      }
      const currentSrc = videoPlayer.getAttribute('src');
      if (currentSrc !== videoSrc) {
        videoPlayer.setAttribute('src', videoSrc);
        videoPlayer.load();
      } else {
        videoPlayer.currentTime = 0;
      }
      videoPlayer.classList.remove('is-hidden');
      videoPlayer.play().catch(() => {});
    };

    thumbs.forEach(btn => {
      btn.addEventListener('click', () => {
        const type = btn.dataset.type || 'image';
        if (type === 'video') {
          showVideo(btn);
        } else {
          showImage(btn);
        }
        thumbs.forEach(other => {
          other.classList.remove('is-active');
          other.setAttribute('aria-pressed', 'false');
        });
        btn.classList.add('is-active');
        btn.setAttribute('aria-pressed', 'true');
      });
    });
  });
});
</script>
{{ end }}
