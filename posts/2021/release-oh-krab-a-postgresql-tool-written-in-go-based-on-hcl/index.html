<!doctype html><html lang=en dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Sora:wght@400;500;600&display=swap" rel=stylesheet><link rel=canonical href=https://qbart.dev/posts/2021/release-oh-krab-a-postgresql-tool-written-in-go-based-on-hcl/><title>Release: Oh! Krab! A PostgreSQL tool written in Go based on HCL | Bart≈Çomiej W√≥jtowicz</title><meta property="og:type" content="website"><meta property="og:title" content="Release: Oh! Krab! A PostgreSQL tool written in Go based on HCL"><meta property="og:description" content="Engineering blog of Bart≈Çomiej W√≥jtowicz. CTO at Selleo Labs. Co-founder of Soft Kiwi Games. Articles and notes about software, including personal thoughts, small experiments, and things I find interesting along the way."><meta property="og:url" content="https://qbart.dev/posts/2021/release-oh-krab-a-postgresql-tool-written-in-go-based-on-hcl/"><meta property="og:site_name" content="Bart≈Çomiej W√≥jtowicz"><link rel=stylesheet href=/css/main.min.fdf9f8fa1e61074504e8bdd56cdc59b293b9e3a242688cf1ba74ad72be4d3242.css integrity="sha256-/fn4+h5hB0UE6L3VbNxZspO546JCaIzxunStcr5NMkI=" crossorigin=anonymous><script src=/js/main.3a782c255da1f2c5ba60d3899b7490960df6fbfc0b0a92cf0418b1442316a44b.js integrity="sha256-OngsJV2h8sW6YNOJm3SQlg32+/wLCpLPBBixRCMWpEs=" crossorigin=anonymous></script></head><body id=top><header><div class=container><nav><a href=/ class=logo><svg width="48" height="48" stroke-width="1.5" viewBox="0 0 24 24" fill="none" color="#000"><path d="M13 16h5" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 8l4 4-4 4" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 18V6c0-1.10457.89543-2 2-2H20c1.1046.0 2 .89543 2 2V18C22 19.1046 21.1046 20 20 20H4C2.89543 20 2 19.1046 2 18z" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></a><div class=nav-actions><a href=https://www.linkedin.com/in/bart%C5%82omiej-w%C3%B3jtowicz/ class="btn btn-connect"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden="true"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
Connect</a></div></nav></div></header><main class=container><section class=article><a class=back-link href=/posts/><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
Back</a><article class=article-body><div class=article-header><div class=article-kicker>Writing</div><h1 class=article-title>Release: Oh! Krab! A PostgreSQL tool written in Go based on HCL</h1><div class=article-meta><span>07 Jul, 2021</span>
<span>5 min read</span></div></div><div class=article-grid><div class=article-content><p>I am happy to announce that I have finally finished <a href=https://en.wikipedia.org/wiki/Minimum_viable_product>MVP</a> of my tool for PostgreSQL - <a href=https://ohkrab.dev>Oh! Krab!</a> ü¶Ä.
It&rsquo;s far from perfect but I needed to start somewhere. There&rsquo;s more to come.</p><h2 id=why>Why?</h2><p>So, the natural question is why I&rsquo;ve created this in the first place. There are a few reasons.</p><p>First, I like experimenting with different technologies and sometimes I would like to compare multiple solutions that use PostgreSQL as a database, but writing migrations more than once in different frameworks or programming languages is a pain.
Managing database through other framework migration system is not an option for me.</p><p>Secondly, I get hired from time to time to do small jobs in PostgreSQL (queries, schema design, etc.) and very often I don&rsquo;t have access to the full project so I need to mock everything.
In those situations I would write some Bash scripts that mimic this particular scenario - boooooring!</p><p>Another use case is when I do workshops or teach about PostgreSQL - I really want to work with pure SQL in a manageable fashion, frameworks and <a href=https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping>ORMs</a> would only make the image blurry.</p><p>Last, but not least, is the old project that I&rsquo;ve worked on. It was written in <em>Ruby on Rails</em> and used <em>Apartment</em> gem to manage <a href=https://en.wikipedia.org/wiki/Multitenancy>tenants</a>
(for non-Rubists: Apartment is a library that allows to have different strategies for multitenancy and integrates with Rails ORM).
It perfectly matched our scenario since we had small number of tenants and we knew it wouldn&rsquo;t grow too much so we went with schema-based approach (single database with 1 schema per each tenant and public schema for other stuff).
So, what&rsquo;s wrong with the <em>Apartment</em> then? Well, it&rsquo;s not maintained anymore and if I remember correctly you couldn&rsquo;t upgrade PostgreSQL above version 10 because the way it works is by creating a dump of a database and restoring it to a new schema
and in PostgreSQL 11 dump behavior has changed a little and that prevented <em>Apartment</em> to create a valid restore - I think this issue was later addressed by someone in the community with a workaround but I&rsquo;ve never tested it.
In the past I did a presentation on how to replace <em>Apartment</em> with simple SQL using event triggers so feel free to check it out: <a href=https://qbart.dev/posts/2019/schema-based-multi-tenancy-in-postgresql/>Schema-based multi-tenancy in PostgreSQL</a> - this should work in simple use cases, but it depends what do you need.</p><p>It&rsquo;s hard to write about other reasons since &ldquo;Krab&rdquo; is too small right now compared to what I have planned but I think I will expand on the topic in the future releases as more features are added.</p><h2 id=introduction-to-the-software-itself>Introduction to the software itself</h2><p>I&rsquo;ve tried my best to provide very detailed documentation for <a href=https://ohkrab.dev>Krab</a> so you can start there but if anything is unclear, please let me know so I can make it better.</p><p>Currently Krab only supports one feature - <a href=https://en.wikipedia.org/wiki/Schema_migration>migrations</a> - which again is not polished enough to my liking but it&rsquo;s a starting point.</p><p>Let&rsquo;s start by defining a <code>docker-compose.yml</code> file so we can run database:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>version: <span style=color:#666;font-style:italic>&#34;3&#34;</span>
</span></span><span style=display:flex><span>services:
</span></span><span style=display:flex><span>  pg:
</span></span><span style=display:flex><span>    image: postgres:12.3-alpine
</span></span><span style=display:flex><span>    restart: always
</span></span><span style=display:flex><span>    ports:
</span></span><span style=display:flex><span>      - 5432:5432
</span></span><span style=display:flex><span>    environment:
</span></span><span style=display:flex><span>      POSTGRES_PASSWORD: secret
</span></span><span style=display:flex><span>      POSTGRES_USER: krab
</span></span><span style=display:flex><span>      POSTGRES_DB: krab
</span></span></code></pre></div><p>Then start the container:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose up
</span></span></code></pre></div><p>Next, install the Krab, possible options of how to do it are <a href=https://ohkrab.dev/docs/get_started/installation/>here</a>. For local development prefer <code>asdf</code> version.
Try in your terminal:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>krab -version
</span></span></code></pre></div><p>It should print the active version, e.g.: <code>0.2.4</code>.</p><p>Then we define the <a href=https://ohkrab.dev/docs/configuration/overview/>configuration</a>, it can be done in separate files as your project grows but for now let&rsquo;s create one file <code>default.krab.hcl</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#888;font-style:italic># 1
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span><span style=font-weight:700;text-decoration:underline>migration</span> <span style=color:#666;font-style:italic>&#34;create_animals&#34;</span> {
</span></span><span style=display:flex><span>  version = <span style=color:#666;font-style:italic>&#34;20200707_1703&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=font-weight:700;text-decoration:underline>up</span> {
</span></span><span style=display:flex><span>	sql = <span>&lt;&lt;</span><span style=font-weight:700;text-decoration:underline>SQL</span>
</span></span><span style=display:flex><span>      <span style=font-weight:700;text-decoration:underline>CREATE</span> <span style=font-weight:700;text-decoration:underline>TABLE</span> <span style=font-weight:700;text-decoration:underline>animals</span>(
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>id</span>   <span style=font-weight:700;text-decoration:underline>BIGINT</span> <span style=font-weight:700;text-decoration:underline>GENERATED</span> <span style=font-weight:700;text-decoration:underline>BY</span> <span style=font-weight:700;text-decoration:underline>DEFAULT</span> <span style=font-weight:700;text-decoration:underline>AS</span> <span style=font-weight:700;text-decoration:underline>IDENTITY</span>,
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>name</span> <span style=font-weight:700;text-decoration:underline>VARCHAR</span>
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>SQL</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=font-weight:700;text-decoration:underline>down</span> {
</span></span><span style=display:flex><span>	sql = <span style=color:#666;font-style:italic>&#34;DROP TABLE animals&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#888;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 2
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span><span style=font-weight:700;text-decoration:underline>migration</span> <span style=color:#666;font-style:italic>&#34;seed_animals&#34;</span> {
</span></span><span style=display:flex><span>  version = <span style=color:#666;font-style:italic>&#34;20200707_1704&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=font-weight:700;text-decoration:underline>up</span> {
</span></span><span style=display:flex><span>	sql = <span style=color:#666;font-style:italic>&#34;INSERT INTO animals(name) VALUES (&#39;Turtle&#39;)&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=font-weight:700;text-decoration:underline>down</span> {
</span></span><span style=display:flex><span>    sql = &#34;DELETE FROM animals WHERE name = <span>&#39;</span><span style=font-weight:700;text-decoration:underline>Turtle</span><span>&#39;&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#888;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic># define the migration set
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span><span style=font-weight:700;text-decoration:underline>migration_set</span> <span style=color:#666;font-style:italic>&#34;default&#34;</span> {
</span></span><span style=display:flex><span>  migrations = [
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>migration</span>.<span style=font-weight:700;text-decoration:underline>create_animals</span>,
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>migration</span>.<span style=font-weight:700;text-decoration:underline>seed_animals</span>,
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The file above contains two <a href=https://ohkrab.dev/docs/configuration/resources/migration/>migration</a> resources and one <a href=https://ohkrab.dev/docs/configuration/resources/migration_set/>migration set</a> resource.</p><p>Because we defined <code>default</code> migration set in config files, you should see it as a subcommand:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>krab migrate up
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># it won&#39;t run migrations because &lt;set&gt; argument is needed,</span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># instead it will print the subcommands</span>
</span></span></code></pre></div><p>So the output will be the list of available sets to migrate:</p><pre tabindex=0><code>This command is accessed by using one of the subcommands below.

Subcommands:
    default    Migrate `default` up
</code></pre><p>Let&rsquo;s run the migrations:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>DATABASE_URL</span>=<span style=color:#666;font-style:italic>&#34;postgres://krab:secret@localhost:5432/krab?sslmode=disable&#34;</span> <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>  krab migrate up default
</span></span></code></pre></div><p><code>DATABASE_URL</code> environment variable is required, read more <a href=https://ohkrab.dev/docs/configuration/environment_variables/>here</a>.</p><p>It&rsquo;s important to note that <a href=https://ohkrab.dev/docs/commands/migrate/up/>migrate up</a> command will execute migrations in the order defined by the migration set and not by their lexicographical scope - which is different than what most alternatives do.
Version here only acts as a unique identifier, its &ldquo;sortability&rdquo; does not matter.</p><p>Now, let&rsquo;s connect to <code>psql</code> and verify everything:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#666;font-style:italic>&#34;postgres://krab:secret@localhost:5432/krab?sslmode=disable&#34;</span> 
</span></span></code></pre></div><p>All migrations should be there:</p><pre tabindex=0><code>krab=# select * from schema_migrations;
    version    
---------------
 20200707_1703
 20200707_1704
(2 rows)
</code></pre><p>As well as our turtle üê¢</p><pre tabindex=0><code>krab=# select * from animals;
 id |  name
----+--------
  1 | Turtle
(1 row)
</code></pre><p>Finally, let&rsquo;s test the <a href=https://ohkrab.dev/docs/commands/migrate/down/>migrate down</a> command:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>DATABASE_URL</span>=<span style=color:#666;font-style:italic>&#34;postgres://krab:secret@localhost:5432/krab?sslmode=disable&#34;</span> <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>  krab migrate down default 20200707_1704
</span></span></code></pre></div><p>And verify it:</p><pre tabindex=0><code>krab=# select * from schema_migrations;
    version    
---------------
 20200707_1703
(1 row)
</code></pre><p>And the turtle üê¢ is gone:</p><pre tabindex=0><code>krab=# select * from animals;
 id | name 
----+------
(0 rows)
</code></pre><p>You can stop the docker container now.</p><h2 id=production>Production?</h2><p>There are still some things that I would like to improve so I would be a bit hesitant to use that in production environment, unless you know what you are doing.
One of the reason is that currently all migrations run within transaction which will cause trouble when running concurrent operations like:
<code>CREATE INDEX CONCURRENTLY ...</code> - I need to allow to specify option like <code>transaction = false</code> for migration resource so that everything works.</p><p>For now treat it as a toy and provide feedback if you wish.</p><h2 id=roadmap-for-the-nearest-future>Roadmap for the nearest future</h2><p>In the upcoming releases I would like to tackle these things:</p><ul><li>adding more customization around migration execution (e.g. transactions)</li><li>improving existing CLI (better progress tracking, config generation)</li><li>building some DSL for migrations (not only raw SQL)</li><li>providing mini test framework (yes, I need that so much)</li><li>adding an ability to create custom actions with arguments</li></ul></div><aside class=article-aside><div class=aside-card><h4>Tags</h4><div class=tag-list><span class=tag>go</span>
<span class=tag>postgres</span>
<span class=tag>sql</span>
<span class=tag>migrations</span>
<span class=tag>hcl</span>
<span class=tag>tool</span></div></div></aside></div><div class=article-footer><a class=back-to-top href=#top><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5l-6 6m6-6 6 6M12 5v14" stroke-linecap="round" stroke-linejoin="round"/></svg>
Back to top</a></div></article></section></main><footer><div class=container><p>"The more I learn, the more I realize how much I don't know."</p></div></footer></body></html>