<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><link rel=icon type=image/ico href=https://qbart.dev//favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://qbart.dev//favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://qbart.dev//favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://qbart.dev//android-chrome-192x192.png><link rel=apple-touch-icon sizes=180x180 href=https://qbart.dev//apple-touch-icon.png><meta name=description content><title>Release: Oh! Krab! A PostgreSQL tool written in Go based on HCL | Bartłomiej Wójtowicz</title><link rel=canonical href=https://qbart.dev/posts/2021/release-oh-krab-a-postgresql-tool-written-in-go-based-on-hcl/><meta property="og:title" content="Release: Oh! Krab! A PostgreSQL tool written in Go based on HCL"><meta property="og:description" content="I am happy to announce that I have finally finished MVP of my tool for PostgreSQL - Oh! Krab! 🦀. It&rsquo;s far from perfect but I needed to start somewhere. There&rsquo;s more to come.
Why? # So, the natural question is why I&rsquo;ve created this in the first place. There are a few reasons.
First, I like experimenting with different technologies and sometimes I would like to compare multiple solutions that use PostgreSQL as a database, but writing migrations more than once in different frameworks or programming languages is a pain."><meta property="og:type" content="article"><meta property="og:url" content="https://qbart.dev/posts/2021/release-oh-krab-a-postgresql-tool-written-in-go-based-on-hcl/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-07T01:32:00+02:00"><meta property="article:modified_time" content="2021-07-07T01:32:00+02:00"><link rel=stylesheet href=/assets/combined.min.8a40377d5e25e43ec69cc08956d7087cfcd3eeb37426eeea439de49ee157f64e.css media=all><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-143750284-1","auto"),ga("send","pageview"))</script></head><body class=auto><div class=content><header><div class=header><h1 class=header-title><a href=https://qbart.dev/>Bartłomiej Wójtowicz</a></h1><div class=flex><p class=small><a href=/>/home</a></p><p class=small><a href=/posts>/posts</a></p><p class=small><a href=/projects/>/projects</a></p><p class=small><a href=/tags>/tags</a></p></div></div></header><main class=main><div><div class=single-intro-container><h1 class=single-title>Release: Oh! Krab! A PostgreSQL tool written in Go based on HCL</h1><p class=single-readtime><time datetime=2021-07-07T01:32:00+02:00>July 7, 2021</time>
&nbsp; · &nbsp;
5 min read</p></div><aside class=toc><p><strong>Table of contents</strong></p><nav id=TableOfContents><ul><li><a href=#why>Why?</a></li><li><a href=#introduction-to-the-software-itself>Introduction to the software itself</a></li><li><a href=#production>Production?</a></li><li><a href=#roadmap-for-the-nearest-future>Roadmap for the nearest future</a></li></ul></nav></aside><div class=single-content><p>I am happy to announce that I have finally finished <a href=https://en.wikipedia.org/wiki/Minimum_viable_product>MVP</a> of my tool for PostgreSQL - <a href=https://ohkrab.dev>Oh! Krab!</a> 🦀.
It&rsquo;s far from perfect but I needed to start somewhere. There&rsquo;s more to come.</p><h2 class=heading id=why>Why?
<a class=anchor href=#why>#</a></h2><p>So, the natural question is why I&rsquo;ve created this in the first place. There are a few reasons.</p><p>First, I like experimenting with different technologies and sometimes I would like to compare multiple solutions that use PostgreSQL as a database, but writing migrations more than once in different frameworks or programming languages is a pain.
Managing database through other framework migration system is not an option for me.</p><p>Secondly, I get hired from time to time to do small jobs in PostgreSQL (queries, schema design, etc.) and very often I don&rsquo;t have access to the full project so I need to mock everything.
In those situations I would write some Bash scripts that mimic this particular scenario - boooooring!</p><p>Another use case is when I do workshops or teach about PostgreSQL - I really want to work with pure SQL in a manageable fashion, frameworks and <a href=https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping>ORMs</a> would only make the image blurry.</p><p>Last, but not least, is the old project that I&rsquo;ve worked on. It was written in <em>Ruby on Rails</em> and used <em>Apartment</em> gem to manage <a href=https://en.wikipedia.org/wiki/Multitenancy>tenants</a>
(for non-Rubists: Apartment is a library that allows to have different strategies for multitenancy and integrates with Rails ORM).
It perfectly matched our scenario since we had small number of tenants and we knew it wouldn&rsquo;t grow too much so we went with schema-based approach (single database with 1 schema per each tenant and public schema for other stuff).
So, what&rsquo;s wrong with the <em>Apartment</em> then? Well, it&rsquo;s not maintained anymore and if I remember correctly you couldn&rsquo;t upgrade PostgreSQL above version 10 because the way it works is by creating a dump of a database and restoring it to a new schema
and in PostgreSQL 11 dump behavior has changed a little and that prevented <em>Apartment</em> to create a valid restore - I think this issue was later addressed by someone in the community with a workaround but I&rsquo;ve never tested it.
In the past I did a presentation on how to replace <em>Apartment</em> with simple SQL using event triggers so feel free to check it out: <a href=https://qbart.dev/posts/2019/schema-based-multi-tenancy-in-postgresql/>Schema-based multi-tenancy in PostgreSQL</a> - this should work in simple use cases, but it depends what do you need.</p><p>It&rsquo;s hard to write about other reasons since &ldquo;Krab&rdquo; is too small right now compared to what I have planned but I think I will expand on the topic in the future releases as more features are added.</p><h2 class=heading id=introduction-to-the-software-itself>Introduction to the software itself
<a class=anchor href=#introduction-to-the-software-itself>#</a></h2><p>I&rsquo;ve tried my best to provide very detailed documentation for <a href=https://ohkrab.dev>Krab</a> so you can start there but if anything is unclear, please let me know so I can make it better.</p><p>Currently Krab only supports one feature - <a href=https://en.wikipedia.org/wiki/Schema_migration>migrations</a> - which again is not polished enough to my liking but it&rsquo;s a starting point.</p><p>Let&rsquo;s start by defining a <code>docker-compose.yml</code> file so we can run database:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>version: <span style=color:#666;font-style:italic>&#34;3&#34;</span>
</span></span><span style=display:flex><span>services:
</span></span><span style=display:flex><span>  pg:
</span></span><span style=display:flex><span>    image: postgres:12.3-alpine
</span></span><span style=display:flex><span>    restart: always
</span></span><span style=display:flex><span>    ports:
</span></span><span style=display:flex><span>      - 5432:5432
</span></span><span style=display:flex><span>    environment:
</span></span><span style=display:flex><span>      POSTGRES_PASSWORD: secret
</span></span><span style=display:flex><span>      POSTGRES_USER: krab
</span></span><span style=display:flex><span>      POSTGRES_DB: krab
</span></span></code></pre></div><p>Then start the container:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose up
</span></span></code></pre></div><p>Next, install the Krab, possible options of how to do it are <a href=https://ohkrab.dev/docs/get_started/installation/>here</a>. For local development prefer <code>asdf</code> version.
Try in your terminal:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>krab -version
</span></span></code></pre></div><p>It should print the active version, e.g.: <code>0.2.4</code>.</p><p>Then we define the <a href=https://ohkrab.dev/docs/configuration/overview/>configuration</a>, it can be done in separate files as your project grows but for now let&rsquo;s create one file <code>default.krab.hcl</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#888;font-style:italic># 1
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span><span style=font-weight:700;text-decoration:underline>migration</span> <span style=color:#666;font-style:italic>&#34;create_animals&#34;</span> {
</span></span><span style=display:flex><span>  version = <span style=color:#666;font-style:italic>&#34;20200707_1703&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=font-weight:700;text-decoration:underline>up</span> {
</span></span><span style=display:flex><span>	sql = <span>&lt;&lt;</span><span style=font-weight:700;text-decoration:underline>SQL</span>
</span></span><span style=display:flex><span>      <span style=font-weight:700;text-decoration:underline>CREATE</span> <span style=font-weight:700;text-decoration:underline>TABLE</span> <span style=font-weight:700;text-decoration:underline>animals</span>(
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>id</span>   <span style=font-weight:700;text-decoration:underline>BIGINT</span> <span style=font-weight:700;text-decoration:underline>GENERATED</span> <span style=font-weight:700;text-decoration:underline>BY</span> <span style=font-weight:700;text-decoration:underline>DEFAULT</span> <span style=font-weight:700;text-decoration:underline>AS</span> <span style=font-weight:700;text-decoration:underline>IDENTITY</span>,
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>name</span> <span style=font-weight:700;text-decoration:underline>VARCHAR</span>
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>SQL</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=font-weight:700;text-decoration:underline>down</span> {
</span></span><span style=display:flex><span>	sql = <span style=color:#666;font-style:italic>&#34;DROP TABLE animals&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#888;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 2
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span><span style=font-weight:700;text-decoration:underline>migration</span> <span style=color:#666;font-style:italic>&#34;seed_animals&#34;</span> {
</span></span><span style=display:flex><span>  version = <span style=color:#666;font-style:italic>&#34;20200707_1704&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=font-weight:700;text-decoration:underline>up</span> {
</span></span><span style=display:flex><span>	sql = <span style=color:#666;font-style:italic>&#34;INSERT INTO animals(name) VALUES (&#39;Turtle&#39;)&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=font-weight:700;text-decoration:underline>down</span> {
</span></span><span style=display:flex><span>    sql = &#34;DELETE FROM animals WHERE name = <span>&#39;</span><span style=font-weight:700;text-decoration:underline>Turtle</span><span>&#39;&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#888;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic># define the migration set
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span><span style=font-weight:700;text-decoration:underline>migration_set</span> <span style=color:#666;font-style:italic>&#34;default&#34;</span> {
</span></span><span style=display:flex><span>  migrations = [
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>migration</span>.<span style=font-weight:700;text-decoration:underline>create_animals</span>,
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>migration</span>.<span style=font-weight:700;text-decoration:underline>seed_animals</span>,
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The file above contains two <a href=https://ohkrab.dev/docs/configuration/resources/migration/>migration</a> resources and one <a href=https://ohkrab.dev/docs/configuration/resources/migration_set/>migration set</a> resource.</p><p>Because we defined <code>default</code> migration set in config files, you should see it as a subcommand:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>krab migrate up
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># it won&#39;t run migrations because &lt;set&gt; argument is needed,</span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># instead it will print the subcommands</span>
</span></span></code></pre></div><p>So the output will be the list of available sets to migrate:</p><pre tabindex=0><code>This command is accessed by using one of the subcommands below.

Subcommands:
    default    Migrate `default` up
</code></pre><p>Let&rsquo;s run the migrations:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>DATABASE_URL</span>=<span style=color:#666;font-style:italic>&#34;postgres://krab:secret@localhost:5432/krab?sslmode=disable&#34;</span> <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>  krab migrate up default
</span></span></code></pre></div><p><code>DATABASE_URL</code> environment variable is required, read more <a href=https://ohkrab.dev/docs/configuration/environment_variables/>here</a>.</p><p>It&rsquo;s important to note that <a href=https://ohkrab.dev/docs/commands/migrate/up/>migrate up</a> command will execute migrations in the order defined by the migration set and not by their lexicographical scope - which is different than what most alternatives do.
Version here only acts as a unique identifier, its &ldquo;sortability&rdquo; does not matter.</p><p>Now, let&rsquo;s connect to <code>psql</code> and verify everything:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#666;font-style:italic>&#34;postgres://krab:secret@localhost:5432/krab?sslmode=disable&#34;</span> 
</span></span></code></pre></div><p>All migrations should be there:</p><pre tabindex=0><code>krab=# select * from schema_migrations;
    version    
---------------
 20200707_1703
 20200707_1704
(2 rows)
</code></pre><p>As well as our turtle 🐢</p><pre tabindex=0><code>krab=# select * from animals;
 id |  name
----+--------
  1 | Turtle
(1 row)
</code></pre><p>Finally, let&rsquo;s test the <a href=https://ohkrab.dev/docs/commands/migrate/down/>migrate down</a> command:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>DATABASE_URL</span>=<span style=color:#666;font-style:italic>&#34;postgres://krab:secret@localhost:5432/krab?sslmode=disable&#34;</span> <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>  krab migrate down default 20200707_1704
</span></span></code></pre></div><p>And verify it:</p><pre tabindex=0><code>krab=# select * from schema_migrations;
    version    
---------------
 20200707_1703
(1 row)
</code></pre><p>And the turtle 🐢 is gone:</p><pre tabindex=0><code>krab=# select * from animals;
 id | name 
----+------
(0 rows)
</code></pre><p>You can stop the docker container now.</p><h2 class=heading id=production>Production?
<a class=anchor href=#production>#</a></h2><p>There are still some things that I would like to improve so I would be a bit hesitant to use that in production environment, unless you know what you are doing.
One of the reason is that currently all migrations run within transaction which will cause trouble when running concurrent operations like:
<code>CREATE INDEX CONCURRENTLY ...</code> - I need to allow to specify option like <code>transaction = false</code> for migration resource so that everything works.</p><p>For now treat it as a toy and provide feedback if you wish.</p><h2 class=heading id=roadmap-for-the-nearest-future>Roadmap for the nearest future
<a class=anchor href=#roadmap-for-the-nearest-future>#</a></h2><p>In the upcoming releases I would like to tackle these things:</p><ul><li>adding more customization around migration execution (e.g. transactions)</li><li>improving existing CLI (better progress tracking, config generation)</li><li>building some DSL for migrations (not only raw SQL)</li><li>providing mini test framework (yes, I need that so much)</li><li>adding an ability to create custom actions with arguments</li></ul></div><div class=single-pagination><hr><div class=flex><div class=single-pagination-prev><div class=single-pagination-container-prev><div class=single-pagination-text>←</div><div class=single-pagination-text><a href=/posts/2021/how-to-rebuild-existing-software/>How to rebuild existing software</a></div></div></div><div class=single-pagination-next><div class=single-pagination-container-next><div class=single-pagination-text><a href=/posts/2021/the-beginners-guide-to-devops/>The Beginner's Guide to DevOps</a></div><div class=single-pagination-text>→</div></div></div></div><hr></div><div class=back-to-top><a href=#top>back to top</a></div></div></main></div><footer><p>&ldquo;The more I learn, the more I realize how much I don&rsquo;t know.&rdquo;</p></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script></body><script src=/js/theme-switch.js></script>
<script defer src=/js/copy-code.js></script></html>